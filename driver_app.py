import streamlit as st
import pandas as pd
import datetime
import plotly.express as px

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö ---
# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏ñ‡∏™‡∏µ‡πÅ‡∏î‡∏á üöó ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö", page_icon="üöó", layout="wide")

# ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
DATA_FILE = "driver_data.csv"

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
def load_data():
    try:
        df = pd.read_csv(DATA_FILE)
    except FileNotFoundError:
        df = pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])
    return df

def save_data(df):
    df.to_csv(DATA_FILE, index=False)

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (Session State)
if 'data' not in st.session_state:
    st.session_state.data = load_data()

# ==========================================
# üîß ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (AUTO-FIX SYSTEM)
# ==========================================
# ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏´‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
if 'Category' in st.session_state.data.columns or 'Date' in st.session_state.data.columns:
    eng_to_thai = {
        'Date': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
        'Time': '‡πÄ‡∏ß‡∏•‡∏≤',
        'Platform': '‡πÅ‡∏≠‡∏õ',
        'Category': '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',
        'SubCategory': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        'Amount_Gross': '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ',
        'Deduction': '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢',
        'Tip': '‡∏ó‡∏¥‡∏õ',
        'Net_Income': '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
        'Distance_Km': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)',
        'Note': '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
    }
    st.session_state.data.rename(columns=eng_to_thai, inplace=True)
    # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß
    save_data(st.session_state.data)

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á)
required_columns = [
    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
    '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
]

for col in required_columns:
    if col not in st.session_state.data.columns:
        if col in ['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)']:
            st.session_state.data[col] = 0.0
        else:
            st.session_state.data[col] = ""

# ==========================================
# ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
# ==========================================

# --- 2. ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (Sidebar) ---
with st.sidebar:
    st.title("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö")
    st.write("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
    maxim_comm_rate = st.slider("Maxim ‡∏´‡∏±‡∏Å‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô (%)", 0, 30, 15) / 100
    ev_home_rate = st.number_input("‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)", value=40, step=5)
    
    st.divider()
    st.info("üí° ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π '‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤")
    
    # ‡∏õ‡∏∏‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if st.button("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)", type="primary"):
        st.session_state.data = pd.DataFrame(columns=required_columns)
        save_data(st.session_state.data)
        st.rerun()

# --- 3. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å (Main App) ---
st.title("üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (Driver Pro)")

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏ö 3 ‡∏´‡∏ô‡πâ‡∏≤
tab1, tab2, tab3 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô", "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≥‡πÑ‡∏£", "üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"])

# ==========================================
# TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (Entry)
# ==========================================
with tab1:
    col_type, col_form = st.columns([1, 2])
    
    with col_type:
        st.subheader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        entry_type = st.radio(
            "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            ["üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ", "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü", "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ", "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
            captions=["‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô", "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü", "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏≠‡∏õ", "‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô/‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°/‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]
        )

    with col_form:
        st.container(border=True)
        # --- ‡∏ü‡∏≠‡∏£‡πå‡∏° 1: ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ---
        if entry_type == "üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ":
            st.markdown("#### üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
            platform = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ", ["Grab", "Bolt", "Line Man", "Maxim", "Robinhood", "Win", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"])
            
            c1, c2 = st.columns(2)
            with c1: 
                app_price = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ (‡∏ö‡∏≤‡∏ó)", min_value=0.0, step=10.0)
            with c2: 
                real_receive = st.number_input("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏õ)", min_value=0.0, value=app_price, step=10.0)
            
            distance = st.number_input("‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ (‡∏Å‡∏°.)", min_value=0.0, step=1.0)
            note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)")
            
            if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‚úÖ", type="primary", use_container_width=True):
                if app_price > 0:
                    deduction = 0
                    tip = max(0, real_receive - app_price)
                    
                    # Logic ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Maxim/‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å ‡∏Ñ‡∏¥‡∏î % ‡∏´‡∏±‡∏Å)
                    if platform in ["Maxim", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"]:
                        deduction = app_price * maxim_comm_rate
                        net_income = app_price - deduction + tip
                    else:
                        # Grab/Bolt ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î Net ‡πÅ‡∏•‡πâ‡∏ß
                        net_income = app_price + tip 

                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': datetime.date.today(),
                        '‡πÄ‡∏ß‡∏•‡∏≤': datetime.datetime.now().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': platform,
                        '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
                        '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': app_price,
                        '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': deduction,
                        '‡∏ó‡∏¥‡∏õ': tip,
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': net_income,
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': distance,
                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': note
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ {net_income:.0f} ‡∏ö‡∏≤‡∏ó")

        # --- ‡∏ü‡∏≠‡∏£‡πå‡∏° 2: ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ---
        elif entry_type == "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü":
            st.markdown("#### ‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô")
            e_type = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", "üîå ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"], horizontal=True)
            
            cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)", value=(ev_home_rate if "‡∏ö‡πâ‡∏≤‡∏ô" in e_type else 0.0))
            note = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏õ‡∏±‡πä‡∏°")
            
            if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô üí∏", type="primary", use_container_width=True):
                if cost > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': datetime.date.today(),
                        '‡πÄ‡∏ß‡∏•‡∏≤': datetime.datetime.now().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                        '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                        '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0,
                        '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost,
                        '‡∏ó‡∏¥‡∏õ': 0,
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost, # ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏ö
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0,
                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"{e_type} - {note}"
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

        # --- ‡∏ü‡∏≠‡∏£‡πå‡∏° 3: ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ---
        elif entry_type == "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ":
            st.markdown("#### üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÅ‡∏≠‡∏õ")
            platform = st.selectbox("‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÑ‡∏´‡∏ô?", ["Grab Wallet", "Bolt Balance", "Maxim", "Line Man Credit"])
            amount = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, step=100.0)
            
            if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô", type="primary", use_container_width=True):
                new_row = {
                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': datetime.date.today(),
                    '‡πÄ‡∏ß‡∏•‡∏≤': datetime.datetime.now().strftime("%H:%M"),
                    '‡πÅ‡∏≠‡∏õ': platform,
                    '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                    '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï',
                    '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0,
                    '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': amount,
                    '‡∏ó‡∏¥‡∏õ': 0,
                    '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -amount,
                    '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0,
                    '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏á‡∏≤‡∏ô"
                }
                st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                save_data(st.session_state.data)
                st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

        # --- ‡∏ü‡∏≠‡∏£‡πå‡∏° 4: ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
        elif entry_type == "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
             st.markdown("#### üõ†Ô∏è ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ")
             cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0)
             note = st.text_input("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏∞‡∏¢‡∏≤‡∏á, ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏Å‡∏≤‡πÅ‡∏ü)")
             if st.button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", type="primary", use_container_width=True):
                 new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': datetime.date.today(),
                        '‡πÄ‡∏ß‡∏•‡∏≤': datetime.datetime.now().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                        '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                        '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0,
                        '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost,
                        '‡∏ó‡∏¥‡∏õ': 0,
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost,
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0,
                        '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': note
                    }
                 st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                 save_data(st.session_state.data)
                 st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

# ==========================================
# TAB 2: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (Analytics)
# ==========================================
with tab2:
    df = st.session_state.data
    
    if not df.empty:
        # üü¢ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢ Error ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß
        income_df = df[df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö']
        expense_df = df[df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢']
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
        total_income = income_df['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum()
        total_tips = income_df['‡∏ó‡∏¥‡∏õ'].sum()
        
        # ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
        fuel_cost = expense_df[expense_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
        topup_cost = expense_df[expense_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
        other_cost = expense_df[expense_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
        
        total_km = income_df['‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)'].sum()
        
        # ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
        net_profit_pocket = total_income - fuel_cost - other_cost
        
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Metrics)
        m1, m2, m3, m4 = st.columns(4)
        m1.metric("üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏à‡∏£‡∏¥‡∏á", f"{net_profit_pocket:,.0f} ‡∏ö.", delta="‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
        m2.metric("‚õΩ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü", f"{fuel_cost:,.0f} ‡∏ö.")
        m3.metric("üõ£Ô∏è ‡∏ß‡∏¥‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß", f"{total_km:,.0f} ‡∏Å‡∏°.")
        
        if total_km > 0:
            income_per_km = total_income / total_km
            cost_per_km = fuel_cost / total_km
            m4.metric("üìä ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Å‡∏°.", f"{income_per_km:.2f} ‡∏ö.", f"‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô {cost_per_km:.2f} ‡∏ö./‡∏Å‡∏°.")
        else:
            m4.metric("üìä ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Å‡∏°.", "0.00", "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á")

        st.markdown("---")

        # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        c1, c2 = st.columns(2)
        
        with c1:
            st.subheader("üèÜ ‡πÅ‡∏≠‡∏õ‡πÑ‡∏´‡∏ô‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏µ‡∏™‡∏∏‡∏î?")
            if not income_df.empty:
                plat_sum = income_df.groupby('‡πÅ‡∏≠‡∏õ')['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum().reset_index()
                fig_bar = px.bar(plat_sum, x='‡πÅ‡∏≠‡∏õ', y='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', color='‡πÅ‡∏≠‡∏õ', text_auto=True, title="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏≠‡∏õ")
                st.plotly_chart(fig_bar, use_container_width=True)
            else:
                st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
                
        with c2:
            st.subheader("üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó")
            if not expense_df.empty:
                exp_sum = expense_df.groupby('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£')['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum().reset_index()
                fig_pie = px.pie(exp_sum, values='‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', names='‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', hole=0.4, title="‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢")
                st.plotly_chart(fig_pie, use_container_width=True)
            else:
                st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢")

        # Heatmap ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        st.subheader("üî• ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏¥‡πà‡∏á‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏î‡∏µ?)")
        if not income_df.empty:
            income_df['‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'] = pd.to_datetime(income_df['‡πÄ‡∏ß‡∏•‡∏≤'], format='%H:%M').dt.hour
            fig_hist = px.histogram(income_df, x='‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á', y='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', nbins=24, 
                                  title="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô (0-23 ‡∏ô.)", 
                                  color_discrete_sequence=['#FFD700'],
                                  labels={'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á':'‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤)', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥':'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)'})
            fig_hist.update_layout(bargap=0.1)
            st.plotly_chart(fig_hist, use_container_width=True)
        
    else:
        st.info("üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")

# ==========================================
# TAB 3: ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Database)
# ==========================================
with tab3:
    st.subheader("üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)")
    st.info("üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥")
    
    if not st.session_state.data.empty:
        edited_df = st.data_editor(
            st.session_state.data,
            num_rows="dynamic",
            use_container_width=True,
            key="editor"
        )
        
        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå", type="primary"):
            st.session_state.data = edited_df
            save_data(edited_df)
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
    else:
        st.write("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç")
