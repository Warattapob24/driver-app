import streamlit as st
import pandas as pd
import datetime
import plotly.express as px
import plotly.graph_objects as go
import json
import os
from streamlit_gsheets import GSheetsConnection

# --- 1. CONFIGURATION ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (Speed+)", page_icon="üöó", layout="wide")
SETTINGS_FILE = "settings.json"

# --- TIMEZONE ---
def get_thai_time():
    tz_thai = datetime.timezone(datetime.timedelta(hours=7))
    return datetime.datetime.now(tz_thai)

def get_thai_date():
    return get_thai_time().date()

# --- 2. SETTINGS ---
def load_settings():
    default_settings = {"ev_rate": 40.0}
    if os.path.exists(SETTINGS_FILE):
        try:
            with open(SETTINGS_FILE, "r") as f: return json.load(f)
        except: return default_settings
    return default_settings

def save_settings(settings):
    with open(SETTINGS_FILE, "w") as f: json.dump(settings, f)

# --- 3. DATA LOADING (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Caching ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß) ---
# @st.cache_data(ttl=300) # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ö‡πà‡∏≠‡∏¢‡πÜ
def load_and_clean_data(refresh=False):
    # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Refresh ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Cache ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
    conn = st.connection("gsheets", type=GSheetsConnection)
    try:
        # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (ttl=0 ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏î)
        df = conn.read(ttl=0)
        
        required_cols = [
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ]
        
        if df.empty or len(df.columns) < len(required_cols):
             df = pd.DataFrame(columns=required_cols)
        
        # Clean Data
        col_map = {
            'Date': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Time': '‡πÄ‡∏ß‡∏•‡∏≤', 'Platform': '‡πÅ‡∏≠‡∏õ',
            'Category': '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'SubCategory': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
            'Amount_Gross': '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', 'Deduction': '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢',
            'Tip': '‡∏ó‡∏¥‡∏õ', 'Net_Income': '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
            'Distance_Km': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', 'Note': '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',
            'Odometer': '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå',
            'Payment_Method': '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            'Cash_In': '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß'
        }
        df.rename(columns={k: v for k, v in col_map.items() if k in df.columns}, inplace=True)
        
        # ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        if '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' not in df.columns: df['‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô'] = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        if '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß' not in df.columns: df['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß'] = 0.0

        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        num_cols = ['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå']
        for col in num_cols:
            if col not in df.columns: df[col] = 0.0
            else: df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
            
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df.columns:
            df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.date
            
        return df
        
    except Exception as e:
        # st.error(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}") # ‡∏õ‡∏¥‡∏î Error ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÑ‡∏°‡πà‡∏£‡∏Å
        return pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
def save_data(df):
    conn = st.connection("gsheets", type=GSheetsConnection)
    try:
        df_save = df.copy()
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df_save.columns:
            df_save['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = df_save['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].astype(str)
        conn.update(worksheet="Drivers", data=df_save)
        # st.cache_data.clear() # ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Cache ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
    except Exception as e:
        st.error(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Session
if 'data' not in st.session_state:
    st.session_state.data = load_and_clean_data()

# --- 4. SIDEBAR ---
with st.sidebar:
    st.title("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡πÄ‡∏°‡∏ô‡∏π")
    st.caption(f"‡πÄ‡∏ß‡∏•‡∏≤: {get_thai_time().strftime('%H:%M')}")
    
    # ‡∏õ‡∏∏‡πà‡∏° Refresh ‡πÅ‡∏ö‡∏ö Manual (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏õ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ß‡∏ã‡∏±‡πà‡∏ß)
    if st.button("üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡∏î‡∏µ)", type="primary", use_container_width=True):
        st.cache_data.clear()
        st.session_state.data = load_and_clean_data(refresh=True)
        st.rerun()
    
    current_settings = load_settings()
    new_ev_rate = st.number_input("‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", value=float(current_settings.get("ev_rate", 40.0)), step=5.0)
    
    if new_ev_rate != current_settings.get("ev_rate"):
        save_settings({"ev_rate": new_ev_rate})
        st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÅ‡∏•‡πâ‡∏ß!")
    
    ev_home_rate = new_ev_rate
    
    st.divider()
    if st.button("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"):
        st.warning("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢")

# --- 5. MAIN APP ---
st.title("üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (Pro)")
tab1, tab2, tab3, tab4 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤", "üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏≤‡∏ü", "üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"])

# ==========================================
# TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
# ==========================================
with tab1:
    col_type, col_form = st.columns([1, 2])
    with col_type:
        st.subheader("‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        entry_type = st.radio(
            "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            ["üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ", "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü", "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ", "üïí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô/‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå)", "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
        )

    with col_form:
        st.container(border=True)
        
        # 1. ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
        if entry_type == "üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ":
            st.markdown("#### üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
            with st.form(key="form_income", clear_on_submit=True):
                c_app, c_pay = st.columns(2)
                with c_app:
                    platform = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ", ["Grab", "Bolt", "Line Man", "Maxim", "Robinhood", "Win", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"])
                with c_pay:
                    pay_method = st.selectbox("‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô", ["üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÇ‡∏≠‡∏ô", "üí≥ ‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ï‡∏£/‡πÅ‡∏≠‡∏õ"])

                c1, c2 = st.columns(2)
                with c1: app_price = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ (‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°)", min_value=0.0, step=10.0, value=None)
                with c2: real_receive = st.number_input("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤)", min_value=0.0, step=10.0, value=None)
                
                note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏¥‡∏õ, ‡∏á‡∏≤‡∏ô‡πÑ‡∏Å‡∏•")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‚úÖ", type="primary", use_container_width=True)
                
                if submitted:
                    price_val = app_price if app_price is not None else 0.0
                    real_val = real_receive if real_receive is not None else 0.0
                    
                    if price_val > 0 or real_val > 0:
                        if real_val == 0: real_val = price_val # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ
                        
                        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ó‡∏¥‡∏õ)
                        diff = real_val - price_val
                        tip = diff if diff > 0 else 0
                        deduction = abs(diff) if diff < 0 else 0 # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å
                        
                        cash_in_hand = real_val if pay_method == "üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡πÇ‡∏≠‡∏ô" else 0.0
                        
                        new_row = {
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                            '‡πÅ‡∏≠‡∏õ': platform, '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô': pay_method,
                            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': price_val, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': deduction, '‡∏ó‡∏¥‡∏õ': tip, 
                            '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': real_val, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß': cash_in_hand, 
                            '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': note
                        }
                        st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                        save_data(st.session_state.data)
                        st.toast(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ {real_val:.0f} ‡∏ö‡∏≤‡∏ó")
                        st.rerun()
                    else: st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô")

        # 2. ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
        elif entry_type == "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ":
            st.markdown("#### üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ")
            with st.form(key="form_topup", clear_on_submit=True):
                sub_cat = st.selectbox("‡πÅ‡∏≠‡∏õ‡πÑ‡∏´‡∏ô", ["Grab Wallet", "Bolt", "Maxim", "Line Man", "Robinhood"])
                cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°", min_value=0.0)
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üíæ", type="primary", use_container_width=True)
                
                if submitted and cost > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': sub_cat, '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô': '‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost, '‡∏ó‡∏¥‡∏õ': 0, 
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß': -cost, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': 'Top-up'
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß")
                    st.rerun()

        # 3. ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
        elif entry_type == "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü":
            st.markdown("#### ‚ö° ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô")
            with st.form(key="form_energy", clear_on_submit=True):
                e_type = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", "üîå ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"], horizontal=True)
                default_val = float(ev_home_rate) if e_type == "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)" else None
                cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0, value=default_val)
                note = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ", type="primary", use_container_width=True)
                if submitted and cost > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô': '‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost, '‡∏ó‡∏¥‡∏õ': 0, 
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß': -cost, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"{e_type} - {note}"
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.rerun()

        # 4. ‡πÑ‡∏°‡∏•‡πå
        elif entry_type == "üïí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô/‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå)":
            st.markdown("#### üïí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå")
            with st.form(key="form_odom", clear_on_submit=True):
                shift_type = st.radio("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["‚òÄÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "üåô ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô"], horizontal=True)
                odometer = st.number_input("‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î", min_value=0.0)
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ", type="primary", use_container_width=True)
                if submitted and odometer > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏£‡∏∞‡∏ö‡∏ö', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏Å‡∏∞‡∏á‡∏≤‡∏ô', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': shift_type, '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô': '-',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': 0, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': 0, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß': 0,
                        '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': odometer, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå {shift_type}"
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.rerun()

        # 5. ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô
        elif entry_type == "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
            st.markdown(f"#### üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ")
            with st.form(key="form_other", clear_on_submit=True):
                sub_cat = st.text_input("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏õ‡∏∞‡∏¢‡∏≤‡∏á)")
                cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0)
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ", type="primary", use_container_width=True)
                if submitted and cost > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô': '‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost, '‡∏ó‡∏¥‡∏õ': 0, 
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß': -cost, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': sub_cat
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.rerun()
    st.markdown("<br>" * 5, unsafe_allow_html=True)

# ==========================================
# TAB 2: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤ (NEW FEATURE)
# ==========================================
with tab2:
    st.subheader("üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤ (GP Analysis)")
    
    df = st.session_state.data
    if not df.empty:
        # Filter ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
        rides = df[(df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') & (df['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ'] > 0)].copy()
        
        if not rides.empty:
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (GP)
            # ‡∏™‡∏π‡∏ï‡∏£: (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ - ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á) / ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ * 100
            rides['‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á'] = rides['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ'] - rides['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥']
            rides['GP_Percent'] = (rides['‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á'] / rides['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ']) * 100
            
            # --- 1. ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÅ‡∏≠‡∏õ ---
            st.markdown("##### üèÜ ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏ô‡πà‡∏≤‡∏Ç‡∏±‡∏ö (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)")
            
            # Group by App
            app_stats = rides.groupby('‡πÅ‡∏≠‡∏õ').agg({
                'GP_Percent': 'mean',
                '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': 'mean',
                '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 'count'
            }).reset_index()
            
            app_stats.rename(columns={
                'GP_Percent': '‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%)', 
                '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏á‡∏≤‡∏ô',
                '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô'
            }, inplace=True)
            
            # ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            app_stats['‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%)'] = app_stats['‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%)'].map('{:.1f}%'.format)
            app_stats['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏á‡∏≤‡∏ô'] = app_stats['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏á‡∏≤‡∏ô'].map('{:,.0f}'.format)
            
            st.dataframe(
                app_stats.sort_values(by='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô', ascending=False), 
                use_container_width=True,
                hide_index=True
            )
            
            st.info("üí° **‡∏ó‡∏£‡∏¥‡∏Ñ:** ‡πÅ‡∏≠‡∏õ‡πÑ‡∏´‡∏ô‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å % ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ ‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏≠‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î")

            st.divider()
            
            # --- 2. Scatter Plot: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ vs ‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å ---
            st.markdown("##### üîç ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô (‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ vs GP)")
            fig_scatter = px.scatter(
                rides, 
                x="‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ", 
                y="‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", 
                color="‡πÅ‡∏≠‡∏õ",
                hover_data=["GP_Percent"],
                title="‡∏à‡∏∏‡∏î‡∏¢‡∏¥‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∞‡πÅ‡∏¢‡∏á‡∏°‡∏∏‡∏° ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏∏‡πâ‡∏° (‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)"
            )
            # ‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á 100% (‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏´‡∏±‡∏Å‡πÄ‡∏•‡∏¢)
            fig_scatter.add_shape(type="line", line=dict(dash="dash", width=1, color="gray"),
                x0=0, x1=rides['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ'].max(), y0=0, y1=rides['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ'].max()
            )
            st.plotly_chart(fig_scatter, use_container_width=True)
            
        else:
            st.warning("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì GP")
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

# ==========================================
# TAB 3: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (NEW FEATURE)
# ==========================================
with tab3:
    st.subheader("üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°")
    
    df = st.session_state.data
    if not df.empty:
        # ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå
        df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])
        
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
        view_mode = st.radio("‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á", ["‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)", "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ)"], horizontal=True)
        
        stats_df = df.copy()
        
        if view_mode == "‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)":
            last_30 = pd.Timestamp.now() - pd.Timedelta(days=30)
            stats_df = stats_df[stats_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] >= last_30]
            group_col = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'
            x_format = "%d %b"
        else:
            stats_df['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] = stats_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].dt.to_period('M').astype(str)
            group_col = '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'
            x_format = "%b %Y"

        # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
        daily_stats = stats_df.groupby(group_col).agg({
            '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': 'sum',
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 'sum',
            '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': lambda x: x.max() - x.min() if len(x) > 0 else 0
        }).reset_index()
        
        # ‡∏Å‡∏£‡∏≤‡∏ü 1: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
        st.markdown("##### üí∞ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")
        fig_line = px.line(
            daily_stats, x=group_col, y='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            markers=True, title="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏à‡∏£‡∏¥‡∏á",
            line_shape="spline"
        )
        fig_line.update_traces(line_color='#00B14F', line_width=3)
        st.plotly_chart(fig_line, use_container_width=True)
        
        # ‡∏Å‡∏£‡∏≤‡∏ü 2: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ vs ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á
        st.markdown("##### ‚öñÔ∏è ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ vs ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠ GP/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)")
        fig_bar = go.Figure()
        fig_bar.add_trace(go.Bar(x=daily_stats[group_col], y=daily_stats['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ'], name='‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ (Gross)', marker_color='#95A5A6'))
        fig_bar.add_trace(go.Bar(x=daily_stats[group_col], y=daily_stats['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'], name='‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (Net)', marker_color='#2ECC71'))
        fig_bar.update_layout(barmode='group', title="‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡πâ‡∏°")
        st.plotly_chart(fig_bar, use_container_width=True)

    else:
        st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•")

# ==========================================
# TAB 4: ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
# ==========================================
with tab4:
    st.subheader("üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    
    with st.container(border=True):
        c1, c2, c3 = st.columns(3)
        f_app = c1.multiselect("‡πÅ‡∏≠‡∏õ", st.session_state.data['‡πÅ‡∏≠‡∏õ'].unique())
        f_cat = c2.multiselect("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", st.session_state.data['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'].unique())
        f_date = c3.selectbox("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"])

    df_show = st.session_state.data.copy()
    if f_app: df_show = df_show[df_show['‡πÅ‡∏≠‡∏õ'].isin(f_app)]
    if f_cat: df_show = df_show[df_show['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'].isin(f_cat)]
    if f_date == "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ": df_show = df_show[df_show['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] == get_thai_date()]
    elif f_date == "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ": 
        t = get_thai_date()
        df_show = df_show[(pd.to_datetime(df_show['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.month == t.month) & (pd.to_datetime(df_show['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.year == t.year)]

    if not df_show.empty:
        # Sort ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        df_show = df_show.sort_values(by=["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏ß‡∏•‡∏≤"], ascending=False)
        edited = st.data_editor(df_show, num_rows="dynamic", use_container_width=True, key="editor")
        
        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á", type="primary"):
            try:
                # Logic ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                orig_idx = set(df_show.index)
                curr_idx = set(edited.index)
                deleted = orig_idx - curr_idx
                
                if deleted: st.session_state.data = st.session_state.data.drop(list(deleted))
                st.session_state.data.update(edited)
                save_data(st.session_state.data)
                
                st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                # Force Reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                st.cache_data.clear()
                st.session_state.data = load_and_clean_data(refresh=True)
                st.rerun()
            except Exception as e: st.error(f"Error: {e}")
