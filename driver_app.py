import streamlit as st
import pandas as pd
import datetime
import plotly.express as px

# --- 1. CONFIGURATION ---
st.set_page_config(page_title="Driver Pro Mobile", page_icon="üöó", layout="wide")
DATA_FILE = "driver_data.csv"

# --- TIMEZONE ---
def get_thai_time():
    tz_thai = datetime.timezone(datetime.timedelta(hours=7))
    return datetime.datetime.now(tz_thai)

def get_thai_date():
    return get_thai_time().date()

# --- 2. DATA LOADING ---
def load_and_clean_data():
    try:
        df = pd.read_csv(DATA_FILE)
        col_map = {
            'Date': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Time': '‡πÄ‡∏ß‡∏•‡∏≤', 'Platform': '‡πÅ‡∏≠‡∏õ',
            'Category': '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'SubCategory': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
            'Amount_Gross': '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', 'Deduction': '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢',
            'Tip': '‡∏ó‡∏¥‡∏õ', 'Net_Income': '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
            'Distance_Km': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', 'Note': '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',
            'Odometer': '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'
        }
        df.rename(columns=col_map, inplace=True)
        
        # Ensure numeric columns
        num_cols = ['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå']
        for col in num_cols:
            if col not in df.columns: df[col] = 0.0
            else: df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
            
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df.columns:
            df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.date
            
        return df
    except FileNotFoundError:
        return pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])

def save_data(df):
    df.to_csv(DATA_FILE, index=False)

if 'data' not in st.session_state:
    st.session_state.data = load_and_clean_data()
    save_data(st.session_state.data)

# --- 3. SIDEBAR ---
with st.sidebar:
    st.title("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")
    st.caption(f"Time: {get_thai_time().strftime('%H:%M')}")
    maxim_comm_rate = st.slider("Maxim ‡∏´‡∏±‡∏Å‡∏Ñ‡∏≠‡∏° (%)", 0, 30, 15) / 100
    ev_home_rate = st.number_input("‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", value=40, step=5)
    
    st.divider()
    if st.button("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", type="primary"):
        st.session_state.data = pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])
        save_data(st.session_state.data)
        st.rerun()

# --- 4. MAIN APP ---
st.title("üöó Driver Pro")
tab1, tab2, tab3 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "üìä ‡∏™‡∏£‡∏∏‡∏õ", "üóÇÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"])

# ==========================================
# TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (MOBILE OPTIMIZED)
# ==========================================
with tab1:
    # ‡πÉ‡∏ä‡πâ radio ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ö‡∏±‡∏á)
    entry_type = st.radio(
        "", # ‡∏ã‡πà‡∏≠‡∏ô label ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà
        ["‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô", "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü", "‡πÑ‡∏°‡∏•‡πå(‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö)", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
        horizontal=True,
        label_visibility="collapsed"
    )
    st.write(f"**‡πÄ‡∏°‡∏ô‡∏π:** {entry_type}") # ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÜ ‡πÅ‡∏ó‡∏ô

    # --- 1. ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ---
    if entry_type == "‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô":
        with st.form(key="form_income", clear_on_submit=True):
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
            c_app, c_note = st.columns([1, 1])
            with c_app:
                platform = st.selectbox("‡πÅ‡∏≠‡∏õ", ["Grab", "Bolt", "Line Man", "Maxim", "Robinhood", "Win", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"], label_visibility="collapsed")
            with c_note:
                note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", placeholder="‡πÇ‡∏ô‡πâ‡∏ï‡∏™‡∏±‡πâ‡∏ô‡πÜ", label_visibility="collapsed")

            c1, c2 = st.columns(2)
            with c1: 
                # value=None ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÄ‡∏•‡∏Ç 0
                app_price = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ", min_value=0.0, step=10.0, value=None, placeholder="0")
            with c2: 
                real_receive = st.number_input("‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏¥‡∏õ)", min_value=0.0, step=10.0, value=None, placeholder="‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ")
            
            # ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢
            submitted = st.form_submit_button("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ", type="primary", use_container_width=True)
            
            if submitted:
                # ‡πÅ‡∏õ‡∏•‡∏á None ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                price_val = app_price if app_price is not None else 0.0
                real_val = real_receive if real_receive is not None else 0.0
                
                if price_val > 0 or real_val > 0:
                    if real_val == 0: real_val = price_val # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ
                    
                    deduction = 0
                    tip = max(0, real_val - price_val)
                    
                    if platform in ["Maxim", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"]:
                        deduction = price_val * maxim_comm_rate
                        net_income = price_val - deduction + tip
                    else:
                        net_income = price_val + tip 
                        
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': platform, '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': price_val, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': deduction, '‡∏ó‡∏¥‡∏õ': tip, 
                        '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': net_income, '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': note
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast(f"‡∏£‡∏±‡∏ö {net_income:.0f} ‡∏ö. (‡∏ó‡∏¥‡∏õ {tip:.0f})")
                    st.rerun()
                else:
                    st.warning("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")

    # --- 2. ‡πÑ‡∏°‡∏•‡πå ---
    elif entry_type == "‡πÑ‡∏°‡∏•‡πå(‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö)":
        with st.form(key="form_odom", clear_on_submit=True):
            shift_type = st.radio("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["‚òÄÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "üåô ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô"], horizontal=True)
            
            last_odom = 0.0
            if not st.session_state.data.empty: last_odom = st.session_state.data['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'].max()
            st.caption(f"‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {last_odom:,.0f}")
            
            # value=None ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤
            odometer = st.number_input("‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î", min_value=0.0, step=1.0, value=None, placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå")
            
            submitted = st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡∏•‡πå", type="primary", use_container_width=True)
            
            if submitted:
                odom_val = odometer if odometer is not None else 0.0
                if odom_val > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏£‡∏∞‡∏ö‡∏ö', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏Å‡∏∞‡∏á‡∏≤‡∏ô', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': shift_type,
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': 0, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': 0,
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': odom_val, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå {shift_type}"
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å {shift_type} ‡πÅ‡∏•‡πâ‡∏ß")
                    st.rerun()
                else:
                    st.error("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")

    # --- 3. ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü ---
    elif entry_type == "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü":
        with st.form(key="form_energy", clear_on_submit=True):
            e_type = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô", "üîå ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"], horizontal=True)
            
            # ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ Default ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á
            default_val = ev_home_rate if e_type == "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô" else None
            
            c1, c2 = st.columns(2)
            with c1:
                cost = st.number_input("‡∏ö‡∏≤‡∏ó", min_value=0.0, value=default_val, placeholder="0")
            with c2:
                note = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", placeholder="‡∏õ‡∏±‡πä‡∏°/‡∏à‡∏∏‡∏î‡∏ä‡∏≤‡∏£‡πå‡∏à")

            submitted = st.form_submit_button("üí∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢", type="primary", use_container_width=True)
            
            if submitted:
                cost_val = cost if cost is not None else 0.0
                if cost_val > 0:
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü',
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost_val, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost_val,
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"{e_type} {note}"
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß")
                    st.rerun()
                else:
                    st.warning("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")

    # --- 4. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
    elif entry_type == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
        with st.form(key="form_other", clear_on_submit=True):
            type_other = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏á‡∏≤‡∏ô", "‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏ô/‡∏ã‡πà‡∏≠‡∏°/‡∏≠‡∏∑‡πà‡∏ô‡πÜ"])
            
            sub_cat = ""
            if type_other == "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏á‡∏≤‡∏ô":
                 sub_cat = st.selectbox("‡πÅ‡∏≠‡∏õ", ["Grab Wallet", "Bolt", "Maxim", "Line Man"])
            else:
                 sub_cat = st.text_input("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏õ‡∏∞‡∏¢‡∏≤‡∏á")
            
            cost = st.number_input("‡∏ö‡∏≤‡∏ó", min_value=0.0, value=None, placeholder="0")
            
            submitted = st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", type="primary", use_container_width=True)
            
            if submitted:
                cost_val = cost if cost is not None else 0.0
                if cost_val > 0:
                    item_name = "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" if "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" in type_other else "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
                    new_row = {
                        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                        '‡πÅ‡∏≠‡∏õ': sub_cat if "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" in type_other else '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                        '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item_name,
                        '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost_val, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost_val,
                        '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': sub_cat
                    }
                    st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                    save_data(st.session_state.data)
                    st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß")
                    st.rerun()

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Scroll ‡∏´‡∏•‡∏ö‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
    st.write("<br><br><br>", unsafe_allow_html=True)

# ==========================================
# TAB 2 & 3: ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
# ==========================================
with tab2:
    st.markdown("### üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•")
    filter_col1, _ = st.columns([2, 1])
    with filter_col1:
        time_filter = st.selectbox("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤", ["‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ", "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ", "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"])
    
    df = st.session_state.data
    if not df.empty:
        today = get_thai_date()
        filtered_df = df.copy()
        
        if time_filter == "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ": filtered_df = df[df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] == today]
        elif time_filter == "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ":
            start_week = today - datetime.timedelta(days=today.weekday())
            end_week = start_week + datetime.timedelta(days=6)
            filtered_df = df[(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] >= start_week) & (df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] <= end_week)]
        elif time_filter == "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ": filtered_df = df[(pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.month == today.month) & (pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.year == today.year)]
        elif time_filter == "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ": filtered_df = df[pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.year == today.year]

        if not filtered_df.empty:
            odom_df = filtered_df[filtered_df['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'] > 0]
            daily_dist = 0
            if not odom_df.empty:
                daily_odom = odom_df.groupby('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'].agg(['min', 'max'])
                daily_odom['run_dist'] = daily_odom['max'] - daily_odom['min']
                daily_dist = daily_odom['run_dist'].sum()
            total_km = daily_dist if daily_dist > 0 else filtered_df['‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)'].sum()

            inc_df = filtered_df[filtered_df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö']
            exp_df = filtered_df[filtered_df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢']
            total_inc = inc_df['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum()
            fuel = exp_df[exp_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
            other = exp_df[exp_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
            net = total_inc - fuel - other

            m1, m2, m3, m4 = st.columns(4)
            m1.metric("üí∞ ‡∏Å‡∏≥‡πÑ‡∏£", f"{net:,.0f}")
            m2.metric("‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü", f"{fuel:,.0f}")
            m3.metric("üõ£Ô∏è ‡∏ß‡∏¥‡πà‡∏á(‡∏Å‡∏°.)", f"{total_km:,.0f}")
            if total_km > 0: m4.metric("üìä ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏°.", f"{total_inc/total_km:.1f}")
            else: m4.metric("üìä ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏°.", "-")

            st.divider()
            if not inc_df.empty:
                fig = px.bar(inc_df.groupby('‡πÅ‡∏≠‡∏õ')['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum().reset_index(), x='‡πÅ‡∏≠‡∏õ', y='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', color='‡πÅ‡∏≠‡∏õ', text_auto=True)
                st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ")

with tab3:
    st.subheader("üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    if not st.session_state.data.empty:
        edited = st.data_editor(st.session_state.data, num_rows="dynamic", use_container_width=True)
        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", type="primary"):
            st.session_state.data = edited
            save_data(edited)
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß")
