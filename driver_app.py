import streamlit as st
import pandas as pd
import datetime
import plotly.express as px
import json
import os

# --- 1. CONFIGURATION ---
st.set_page_config(page_title="р╕гр╕░р╕Ър╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕▓р╕вр╣Др╕Фр╣Йр╕Др╕Щр╕Вр╕▒р╕Ъ", page_icon="ЁЯЪЧ", layout="wide")
DATA_FILE = "driver_data.csv"
SETTINGS_FILE = "settings.json"

# --- TIMEZONE ---
def get_thai_time():
┬а ┬а tz_thai = datetime.timezone(datetime.timedelta(hours=7))
┬а ┬а return datetime.datetime.now(tz_thai)

def get_thai_date():
┬а ┬а return get_thai_time().date()

# --- 2. SETTINGS MANAGEMENT ---
def load_settings():
┬а ┬а default_settings = {"maxim_rate": 15, "ev_rate": 40.0}
┬а ┬а if os.path.exists(SETTINGS_FILE):
┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а with open(SETTINGS_FILE, "r") as f: return json.load(f)
┬а ┬а ┬а ┬а except: return default_settings
┬а ┬а return default_settings

def save_settings(settings):
┬а ┬а with open(SETTINGS_FILE, "w") as f: json.dump(settings, f)

# --- 3. DATA LOADING ---
def load_and_clean_data():
┬а ┬а try:
┬а ┬а ┬а ┬а df = pd.read_csv(DATA_FILE)
┬а ┬а ┬а ┬а col_map = {
┬а ┬а ┬а ┬а ┬а ┬а 'Date': 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И', 'Time': 'р╣Ар╕зр╕ер╕▓', 'Platform': 'р╣Бр╕нр╕Ы',
┬а ┬а ┬а ┬а ┬а ┬а 'Category': 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И', 'SubCategory': 'р╕гр╕▓р╕вр╕Бр╕▓р╕г',
┬а ┬а ┬а ┬а ┬а ┬а 'Amount_Gross': 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы', 'Deduction': 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в',
┬а ┬а ┬а ┬а ┬а ┬а 'Tip': 'р╕Чр╕┤р╕Ы', 'Net_Income': 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤',
┬а ┬а ┬а ┬а ┬а ┬а 'Distance_Km': 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)', 'Note': 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕',
┬а ┬а ┬а ┬а ┬а ┬а 'Odometer': 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М'
┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а df.rename(columns=col_map, inplace=True)
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а num_cols = ['р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы', 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в', 'р╕Чр╕┤р╕Ы', 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤', 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)', 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М']
┬а ┬а ┬а ┬а for col in num_cols:
┬а ┬а ┬а ┬а ┬а ┬а if col not in df.columns: df[col] = 0.0
┬а ┬а ┬а ┬а ┬а ┬а else: df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а if 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И' in df.columns:
┬а ┬а ┬а ┬а ┬а ┬а df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] = pd.to_datetime(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.date
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а return df
┬а ┬а except FileNotFoundError:
┬а ┬а ┬а ┬а return pd.DataFrame(columns=[
┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И', 'р╣Ар╕зр╕ер╕▓', 'р╣Бр╕нр╕Ы', 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г',┬а
┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы', 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в', 'р╕Чр╕┤р╕Ы', 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤',┬а
┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)', 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М', 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕'
┬а ┬а ┬а ┬а ])

def save_data(df):
┬а ┬а df.to_csv(DATA_FILE, index=False)

if 'data' not in st.session_state:
┬а ┬а st.session_state.data = load_and_clean_data()
┬а ┬а save_data(st.session_state.data)

# --- 4. SIDEBAR ---
with st.sidebar:
┬а ┬а st.title("тЪЩя╕П р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓")
┬а ┬а st.caption(f"р╣Ар╕зр╕ер╕▓: {get_thai_time().strftime('%H:%M')}")
┬а ┬а┬а
┬а ┬а current_settings = load_settings()
┬а ┬а new_maxim_rate = st.slider("Maxim р╕лр╕▒р╕Бр╕Др╕нр╕б (%)", 0, 30, current_settings.get("maxim_rate", 15))
┬а ┬а new_ev_rate = st.number_input("р╕Др╣Ир╕▓р╣Др╕Яр╕Кр╕▓р╕гр╣Мр╕Ир╕Ър╣Йр╕▓р╕Щ (р╣Ар╕лр╕бр╕▓)", value=float(current_settings.get("ev_rate", 40.0)), step=5.0)
┬а ┬а┬а
┬а ┬а if new_maxim_rate != current_settings.get("maxim_rate") or new_ev_rate != current_settings.get("ev_rate"):
┬а ┬а ┬а ┬а updated_settings = {"maxim_rate": new_maxim_rate, "ev_rate": new_ev_rate}
┬а ┬а ┬а ┬а save_settings(updated_settings)
┬а ┬а ┬а ┬а st.toast("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Бр╕ер╣Йр╕з!")
┬а ┬а┬а
┬а ┬а maxim_comm_rate = new_maxim_rate / 100
┬а ┬а ev_home_rate = new_ev_rate
┬а ┬а┬а
┬а ┬а st.divider()
┬а ┬а if st.button("тЪая╕П р╕ер╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е", type="primary"):
┬а ┬а ┬а ┬а st.session_state.data = pd.DataFrame(columns=[
┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И', 'р╣Ар╕зр╕ер╕▓', 'р╣Бр╕нр╕Ы', 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г',┬а
┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы', 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в', 'р╕Чр╕┤р╕Ы', 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤',┬а
┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)', 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М', 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕'
┬а ┬а ┬а ┬а ])
┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а st.rerun()

# --- 5. MAIN APP ---
st.title("ЁЯЪЧ р╕гр╕░р╕Ър╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕▓р╕вр╣Др╕Фр╣Й")
tab1, tab2, tab3 = st.tabs(["ЁЯУЭ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Зр╕▓р╕Щ", "ЁЯУК р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф", "ЁЯЧВя╕П р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е"])

# ==========================================
# TAB 1: р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Зр╕▓р╕Щ
# ==========================================
with tab1:
┬а ┬а col_type, col_form = st.columns([1, 2])
┬а ┬а with col_type:
┬а ┬а ┬а ┬а st.subheader("р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕▓р╕вр╕Бр╕▓р╕г")
┬а ┬а ┬а ┬а entry_type = st.radio(
┬а ┬а ┬а ┬а ┬а ┬а "р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕гр╕▓р╕вр╕Бр╕▓р╕г",
┬а ┬а ┬а ┬а ┬а ┬а ["ЁЯЪЧ р╕гр╕▒р╕Ър╕Зр╕▓р╕Щр╕Вр╕▒р╕Ър╕гр╕Ц", "тЫ╜ р╣Ар╕Хр╕┤р╕бр╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╕Кр╕▓р╕гр╣Мр╕Ир╣Др╕Я", "ЁЯХТ р╣Ар╕гр╕┤р╣Ир╕бр╕Зр╕▓р╕Щ/р╣Ар╕ер╕┤р╕Бр╕Зр╕▓р╕Щ (р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М)", "ЁЯТ│ р╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Бр╕нр╕Ы", "ЁЯЫая╕П р╕Ир╣Ир╕▓р╕вр╕нр╕╖р╣Ир╕Щр╣Ж"],
┬а ┬а ┬а ┬а )

┬а ┬а with col_form:
┬а ┬а ┬а ┬а st.container(border=True)
┬а ┬а ┬а ┬а # --- 1. р╕гр╕▒р╕Ър╕Зр╕▓р╕Щ ---
┬а ┬а ┬а ┬а if entry_type == "ЁЯЪЧ р╕гр╕▒р╕Ър╕Зр╕▓р╕Щр╕Вр╕▒р╕Ър╕гр╕Ц":
┬а ┬а ┬а ┬а ┬а ┬а st.markdown("#### ЁЯУЭ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕▓р╕вр╣Др╕Фр╣Й")
┬а ┬а ┬а ┬а ┬а ┬а with st.form(key="form_income", clear_on_submit=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а platform = st.selectbox("р╣Ар╕ер╕╖р╕нр╕Бр╣Бр╕нр╕Ы", ["Grab", "Bolt", "Line Man", "Maxim", "Robinhood", "Win", "р╕Зр╕▓р╕Щр╕Щр╕нр╕Б"])
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а c1, c2 = st.columns(2)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а with c1:┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а app_price = st.number_input("р╕гр╕▓р╕Др╕▓р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы", min_value=0.0, step=10.0, value=None, placeholder="0.00")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а with c2:┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Ыр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╣Йр╕Кр╕▒р╕Фр╣Ар╕Ир╕Щр╕Хр╕▓р╕бр╕Чр╕╡р╣Ир╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а real_receive = st.number_input("р╣Ар╕Зр╕┤р╕Щр╕Чр╕╡р╣Ир╕гр╕▒р╕Ър╕Ир╕гр╕┤р╕Зр╕Ир╕▓р╕Бр╕ер╕╣р╕Бр╕Др╣Йр╕▓ (р╕гр╕зр╕бр╕Чр╕┤р╕Ы)", min_value=0.0, step=10.0, value=None, placeholder="р╣Ар╕Чр╣Ир╕▓р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а note = st.text_input("р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕", placeholder="р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Кр╣Ир╕зр╕вр╕Ир╕│")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а submitted = st.form_submit_button("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕▓р╕вр╣Др╕Фр╣Й тЬЕ", type="primary", use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if submitted:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а price_val = app_price if app_price is not None else 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а real_val = real_receive if real_receive is not None else 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if price_val > 0 or real_val > 0:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Бр╕гр╕нр╕Бр╣Ар╕Зр╕┤р╕Щр╕гр╕▒р╕Ър╕Ир╕гр╕┤р╕З р╣Гр╕лр╣Йр╕Цр╕╖р╕нр╕зр╣Ир╕▓р╣Ар╕Чр╣Ир╕▓р╕Бр╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if real_val == 0: real_val = price_val┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а deduction = 0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Др╕│р╕Щр╕зр╕Ур╕Чр╕┤р╕Ы = р╣Ар╕Зр╕┤р╕Щр╕гр╕▒р╕Ър╕Ир╕гр╕┤р╕З - р╕гр╕▓р╕Др╕▓р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а tip = max(0, real_val - price_val)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if platform == "Maxim":
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а deduction = price_val * maxim_comm_rate
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а net_income = price_val - deduction + tip
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а net_income = price_val + tip┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_row = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И': get_thai_date(), 'р╣Ар╕зр╕ер╕▓': get_thai_time().strftime("%H:%M"),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕нр╕Ы': platform, 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И': 'р╕гр╕▓р╕вр╕гр╕▒р╕Ъ', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г': 'р╕Др╣Ир╕▓р╣Вр╕Фр╕вр╕кр╕▓р╕г',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы': price_val, 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в': deduction, 'р╕Чр╕┤р╕Ы': tip,┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤': net_income, 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)': 0, 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М': 0, 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕': note
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.toast(f"р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕│р╣Ар╕гр╣Зр╕И! р╣Ар╕Вр╣Йр╕▓р╕Бр╕гр╕░р╣Ар╕Ыр╣Лр╕▓ {net_income:.0f} р╕Ър╕▓р╕Ч")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.warning("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕вр╕нр╕Фр╣Ар╕Зр╕┤р╕Щ")

┬а ┬а ┬а ┬а # --- 2. р╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╣Др╕Я ---
┬а ┬а ┬а ┬а elif entry_type == "тЫ╜ р╣Ар╕Хр╕┤р╕бр╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╕Кр╕▓р╕гр╣Мр╕Ир╣Др╕Я":
┬а ┬а ┬а ┬а ┬а ┬а st.markdown("#### тЪб р╕Хр╣Йр╕Щр╕Чр╕╕р╕Щр╕Юр╕ер╕▒р╕Зр╕Зр╕▓р╕Щ")
┬а ┬а ┬а ┬а ┬а ┬а with st.form(key="form_energy", clear_on_submit=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а e_type = st.radio("р╕Ыр╕гр╕░р╣Ар╕ар╕Ч", ["тЫ╜ р╕Щр╣Йр╕│р╕бр╕▒р╕Щ", "тЪб р╕Кр╕▓р╕гр╣Мр╕Ир╕Ър╣Йр╕▓р╕Щ (р╣Ар╕лр╕бр╕▓)", "ЁЯФМ р╕Кр╕▓р╕гр╣Мр╕Ир╕кр╕Цр╕▓р╕Щр╕╡"], horizontal=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а default_val = None
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if e_type == "тЪб р╕Кр╕▓р╕гр╣Мр╕Ир╕Ър╣Йр╕▓р╕Щ (р╣Ар╕лр╕бр╕▓)": default_val = float(ev_home_rate)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а cost = st.number_input("р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ (р╕Ър╕▓р╕Ч)", min_value=0.0, value=default_val, placeholder="0.00")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а note = st.text_input("р╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а submitted = st.form_submit_button("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в ЁЯТ╛", type="primary", use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if submitted:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а cost_val = cost if cost is not None else 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if cost_val > 0:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_row = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И': get_thai_date(), 'р╣Ар╕зр╕ер╕▓': get_thai_time().strftime("%H:%M"),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕нр╕Ы': 'р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в', 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И': 'р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г': 'р╕Др╣Ир╕▓р╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╣Др╕Я',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы': 0, 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в': cost_val, 'р╕Чр╕┤р╕Ы': 0, 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤': -cost_val,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)': 0, 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М': 0, 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕': f"{e_type} - {note}"
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.toast("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.warning("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ")

┬а ┬а ┬а ┬а # --- 3. р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М ---
┬а ┬а ┬а ┬а elif entry_type == "ЁЯХТ р╣Ар╕гр╕┤р╣Ир╕бр╕Зр╕▓р╕Щ/р╣Ар╕ер╕┤р╕Бр╕Зр╕▓р╕Щ (р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М)":
┬а ┬а ┬а ┬а ┬а ┬а st.markdown("#### ЁЯХТ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕ер╕Вр╣Др╕бр╕ер╣М")
┬а ┬а ┬а ┬а ┬а ┬а with st.form(key="form_odom", clear_on_submit=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а shift_type = st.radio("р╕кр╕Цр╕▓р╕Щр╕░", ["тШАя╕П р╣Ар╕гр╕┤р╣Ир╕бр╕Зр╕▓р╕Щ", "ЁЯМЩ р╣Ар╕ер╕┤р╕Бр╕Зр╕▓р╕Щ"], horizontal=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а last_odom = 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if not st.session_state.data.empty: last_odom = st.session_state.data['р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М'].max()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.caption(f"р╣Ар╕ер╕Вр╣Др╕бр╕ер╣Мр╕ер╣Ир╕▓р╕кр╕╕р╕Фр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ: {last_odom:,.0f}")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а odometer = st.number_input("р╣Ар╕ер╕Вр╣Др╕бр╕ер╣Мр╕лр╕Щр╣Йр╕▓р╕Ыр╕▒р╕Фр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ", min_value=0.0, step=1.0, value=None, placeholder="р╕Бр╕гр╕нр╕Бр╣Ар╕ер╕Вр╣Др╕бр╕ер╣М")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а submitted = st.form_submit_button("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕ер╕Вр╣Др╕бр╕ер╣М ЁЯТ╛", type="primary", use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if submitted:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а odom_val = odometer if odometer is not None else 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if odom_val > 0:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_row = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И': get_thai_date(), 'р╣Ар╕зр╕ер╕▓': get_thai_time().strftime("%H:%M"),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕нр╕Ы': 'р╕гр╕░р╕Ър╕Ъ', 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И': 'р╕Бр╕░р╕Зр╕▓р╕Щ', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г': shift_type,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы': 0, 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в': 0, 'р╕Чр╕┤р╕Ы': 0, 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤': 0,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)': 0, 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М': odom_val, 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕': f"р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М {shift_type}"
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.toast(f"р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б {shift_type} р╣Бр╕ер╣Йр╕з")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.error("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╣Ар╕ер╕Вр╣Др╕бр╕ер╣М")

┬а ┬а ┬а ┬а # --- 4. р╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Х/р╕нр╕╖р╣Ир╕Щр╣Ж ---
┬а ┬а ┬а ┬а elif entry_type == "ЁЯТ│ р╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Бр╕нр╕Ы" or entry_type == "ЁЯЫая╕П р╕Ир╣Ир╕▓р╕вр╕нр╕╖р╣Ир╕Щр╣Ж":
┬а ┬а ┬а ┬а ┬а ┬а st.markdown(f"#### {entry_type}")
┬а ┬а ┬а ┬а ┬а ┬а with st.form(key="form_other", clear_on_submit=True):
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if "р╣Ар╕Др╕гр╕Фр╕┤р╕Х" in entry_type:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а item_name = "р╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Х"
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а sub_cat = st.selectbox("р╣Бр╕нр╕Ыр╣Др╕лр╕Щ", ["Grab Wallet", "Bolt", "Maxim", "Line Man"])
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а item_name = "р╕Чр╕▒р╣Ир╕зр╣Др╕Ы"
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а sub_cat = st.text_input("р╕гр╕▓р╕вр╕Бр╕▓р╕г (р╣Ар╕Кр╣Ир╕Щ р╕Вр╣Йр╕▓р╕з, р╕Ыр╕░р╕вр╕▓р╕З)")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а cost = st.number_input("р╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ", min_value=0.0, value=None, placeholder="0.00")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а submitted = st.form_submit_button("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б ЁЯТ╛", type="primary", use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if submitted:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а cost_val = cost if cost is not None else 0.0
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if cost_val > 0:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а new_row = {
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕зр╕▒р╕Щр╕Чр╕╡р╣И': get_thai_date(), 'р╣Ар╕зр╕ер╕▓': get_thai_time().strftime("%H:%M"),
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╣Бр╕нр╕Ы': sub_cat if "р╣Ар╕Др╕гр╕Фр╕┤р╕Х" in entry_type else 'р╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в',
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И': 'р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в', 'р╕гр╕▓р╕вр╕Бр╕▓р╕г': item_name,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕вр╕нр╕Фр╣Ар╕Хр╣Зр╕б/р╕лр╕Щр╣Йр╕▓р╣Бр╕нр╕Ы': 0, 'р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в': cost_val, 'р╕Чр╕┤р╕Ы': 0, 'р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤': -cost_val,
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а 'р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)': 0, 'р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М': 0, 'р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕': sub_cat
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.toast("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в")
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.warning("р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Зр╕┤р╕Щ")

# ==========================================
# TAB 2: р╕кр╕гр╕╕р╕Ыр╕Ьр╕е (р╣Ар╕Хр╕┤р╕бр╕Бр╕гр╕▓р╕Яр╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓р╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╕лр╕▓р╕вр╣Др╕Ыр╕Бр╕ер╕▒р╕Ър╕Др╕╖р╕Щр╕бр╕▓р╣Гр╕лр╣Й)
# ==========================================
with tab2:
┬а ┬а st.markdown("### ЁЯУК р╣Бр╕Фр╕Кр╕Ър╕нр╕гр╣Мр╕Фр╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф")
┬а ┬а┬а
┬а ┬а # 1. р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓ (р╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Фр╕┤р╕б)
┬а ┬а time_filter = st.selectbox(
┬а ┬а ┬а ┬а "ЁЯУЕ р╣Ар╕ер╕╖р╕нр╕Бр╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓:",
┬а ┬а ┬а ┬а ["р╕зр╕▒р╕Щр╕Щр╕╡р╣Й", "р╣Ар╕бр╕╖р╣Ир╕нр╕зр╕▓р╕Щ", "р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Щр╕╡р╣Й", "р╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й", "р╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕з", "р╕Ыр╕╡р╕Щр╕╡р╣Й", "р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕нр╕З (р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣И)"]
┬а ┬а )
┬а ┬а┬а
┬а ┬а custom_start_date = None
┬а ┬а custom_end_date = None
┬а ┬а if time_filter == "р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕нр╕З (р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣И)":
┬а ┬а ┬а ┬а st.info("ЁЯСЗ р╣Ар╕ер╕╖р╕нр╕Бр╕Кр╣Ир╕зр╕Зр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Ир╕▓р╕Бр╕Ыр╕Пр╕┤р╕Чр╕┤р╕Щ")
┬а ┬а ┬а ┬а date_range = st.date_input("р╕гр╕░р╕Ър╕╕р╕Кр╣Ир╕зр╕Зр╕зр╕▒р╕Щр╕Чр╕╡р╣И:", value=(get_thai_date(), get_thai_date()), max_value=get_thai_date())
┬а ┬а ┬а ┬а if len(date_range) == 2: custom_start_date, custom_end_date = date_range
┬а ┬а┬а
┬а ┬а df = st.session_state.data
┬а ┬а if not df.empty:
┬а ┬а ┬а ┬а today = get_thai_date()
┬а ┬а ┬а ┬а filtered_df = df.copy()
┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а # --- р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▓р╕бр╣Ар╕зр╕ер╕▓ ---
┬а ┬а ┬а ┬а if time_filter == "р╕зр╕▒р╕Щр╕Щр╕╡р╣Й": filtered_df = df[df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] == today]
┬а ┬а ┬а ┬а elif time_filter == "р╣Ар╕бр╕╖р╣Ир╕нр╕зр╕▓р╕Щ": filtered_df = df[df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] == today - datetime.timedelta(days=1)]
┬а ┬а ┬а ┬а elif time_filter == "р╕кр╕▒р╕Ыр╕Фр╕▓р╕лр╣Мр╕Щр╕╡р╣Й":
┬а ┬а ┬а ┬а ┬а ┬а start_week = today - datetime.timedelta(days=today.weekday())
┬а ┬а ┬а ┬а ┬а ┬а filtered_df = df[(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] >= start_week) & (df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] <= start_week + datetime.timedelta(days=6))]
┬а ┬а ┬а ┬а elif time_filter == "р╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й": filtered_df = df[(pd.to_datetime(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.month == today.month) & (pd.to_datetime(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.year == today.year)]
┬а ┬а ┬а ┬а elif time_filter == "р╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕з":
┬а ┬а ┬а ┬а ┬а ┬а first = today.replace(day=1); last_prev = first - datetime.timedelta(days=1); start_prev = last_prev.replace(day=1)
┬а ┬а ┬а ┬а ┬а ┬а filtered_df = df[(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] >= start_prev) & (df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] <= last_prev)]
┬а ┬а ┬а ┬а elif time_filter == "р╕Ыр╕╡р╕Щр╕╡р╣Й": filtered_df = df[pd.to_datetime(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.year == today.year]
┬а ┬а ┬а ┬а elif time_filter == "р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕нр╕З (р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣И)" and custom_start_date:
┬а ┬а ┬а ┬а ┬а ┬а filtered_df = df[(df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] >= custom_start_date) & (df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] <= custom_end_date)]
┬а ┬а ┬а ┬а elif time_filter == "р╕Бр╕│р╕лр╕Щр╕Фр╣Ар╕нр╕З (р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣И)": filtered_df = pd.DataFrame()

┬а ┬а ┬а ┬а if not filtered_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а # р╕Др╕│р╕Щр╕зр╕Ур╕гр╕░р╕вр╕░р╕Чр╕▓р╕З
┬а ┬а ┬а ┬а ┬а ┬а odom_df = filtered_df[filtered_df['р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М'] > 0]
┬а ┬а ┬а ┬а ┬а ┬а daily_dist = 0
┬а ┬а ┬а ┬а ┬а ┬а if not odom_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а daily_odom = odom_df.groupby('р╕зр╕▒р╕Щр╕Чр╕╡р╣И')['р╣Ар╕ер╕Вр╣Др╕бр╕ер╣М'].agg(['min', 'max'])
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а daily_dist = (daily_odom['max'] - daily_odom['min']).sum()
┬а ┬а ┬а ┬а ┬а ┬а total_km = daily_dist if daily_dist > 0 else filtered_df['р╕гр╕░р╕вр╕░р╕Чр╕▓р╕З(р╕Бр╕б.)'].sum()

┬а ┬а ┬а ┬а ┬а ┬а # р╕Др╕│р╕Щр╕зр╕Ур╣Ар╕Зр╕┤р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а inc_df = filtered_df[filtered_df['р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И'] == 'р╕гр╕▓р╕вр╕гр╕▒р╕Ъ']
┬а ┬а ┬а ┬а ┬а ┬а exp_df = filtered_df[filtered_df['р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И'] == 'р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в']
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а total_inc = inc_df['р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤'].sum()
┬а ┬а ┬а ┬а ┬а ┬а fuel = exp_df[exp_df['р╕гр╕▓р╕вр╕Бр╕▓р╕г'] == 'р╕Др╣Ир╕▓р╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╣Др╕Я']['р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в'].sum()
┬а ┬а ┬а ┬а ┬а ┬а other = exp_df[exp_df['р╕гр╕▓р╕вр╕Бр╕▓р╕г'] == 'р╕Чр╕▒р╣Ир╕зр╣Др╕Ы']['р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в'].sum()
┬а ┬а ┬а ┬а ┬а ┬а topup = exp_df[exp_df['р╕гр╕▓р╕вр╕Бр╕▓р╕г'] == 'р╣Ар╕Хр╕┤р╕бр╣Ар╕Др╕гр╕Фр╕┤р╕Х']['р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в'].sum()
┬а ┬а ┬а ┬а ┬а ┬а total_exp = exp_df['р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в'].sum()
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а net = total_inc - total_exp # р╕Бр╕│р╣Др╕г = р╕гр╕▓р╕вр╕гр╕▒р╕Ъ - р╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕вр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

┬а ┬а ┬а ┬а ┬а ┬а # р╕Др╕│р╕Щр╕зр╕Ур╕Кр╕▒р╣Ир╕зр╣Вр╕бр╕Зр╕Зр╕▓р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а shift_df = filtered_df[filtered_df['р╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И'] == 'р╕Бр╕░р╕Зр╕▓р╕Щ']
┬а ┬а ┬а ┬а ┬а ┬а total_hours = 0
┬а ┬а ┬а ┬а ┬а ┬а if not shift_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а for d in shift_df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'].unique():
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а day_shifts = shift_df[shift_df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И'] == d]
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а starts = day_shifts[day_shifts['р╕гр╕▓р╕вр╕Бр╕▓р╕г'].str.contains("р╣Ар╕гр╕┤р╣Ир╕б")]['р╣Ар╕зр╕ер╕▓']
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ends = day_shifts[day_shifts['р╕гр╕▓р╕вр╕Бр╕▓р╕г'].str.contains("р╣Ар╕ер╕┤р╕Б")]['р╣Ар╕зр╕ер╕▓']
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if not starts.empty and not ends.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а try:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а t_s = pd.to_datetime(starts.min(), format='%H:%M')
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а t_e = pd.to_datetime(ends.max(), format='%H:%M')
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а h = (t_e - t_s).total_seconds() / 3600
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if h < 0: h += 24
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а total_hours += h
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а except: pass

┬а ┬а ┬а ┬а ┬а ┬а # --- р╕кр╣Ир╕зр╕Щр╣Бр╕кр╕Фр╕Зр╕Ьр╕е Metrics ---
┬а ┬а ┬а ┬а ┬а ┬а st.caption(f"р╕кр╕гр╕╕р╕Ыр╕вр╕нр╕Ф: {time_filter}")
┬а ┬а ┬а ┬а ┬а ┬а m1, m2, m3, m4 = st.columns(4)
┬а ┬а ┬а ┬а ┬а ┬а m1.metric("ЁЯТ░ р╕Бр╕│р╣Др╕гр╕кр╕╕р╕Чр╕Шр╕┤ (р╕лр╕▒р╕Бр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕З)", f"{net:,.0f}")
┬а ┬а ┬а ┬а ┬а ┬а m2.metric("тЫ╜ р╕Др╣Ир╕▓р╕Щр╣Йр╕│р╕бр╕▒р╕Щ/р╣Др╕Я", f"{fuel:,.0f}")
┬а ┬а ┬а ┬а ┬а ┬а m3.metric("ЁЯЫгя╕П р╕зр╕┤р╣Ир╕З(р╕Бр╕б.)", f"{total_km:,.0f}")
┬а ┬а ┬а ┬а ┬а ┬а m4.metric("тП▒я╕П р╣Ар╕зр╕ер╕▓р╕Зр╕▓р╕Щ", f"{total_hours:.1f} р╕Кр╕б.")
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а st.divider()
┬а ┬а ┬а ┬а ┬а ┬а s1, s2 = st.columns(2)
┬а ┬а ┬а ┬а ┬а ┬а if total_km > 0: s1.metric("ЁЯУК р╕гр╕▓р╕вр╣Др╕Фр╣Й/р╕Бр╕б.", f"{total_inc/total_km:.1f} р╕Ъ.")
┬а ┬а ┬а ┬а ┬а ┬а if total_hours > 0: s2.metric("ЁЯТ╡ р╕гр╕▓р╕вр╣Др╕Фр╣Й/р╕Кр╕б.", f"{total_inc/total_hours:.0f} р╕Ъ.")

┬а ┬а ┬а ┬а ┬а ┬а # --- р╕кр╣Ир╕зр╕Щр╣Бр╕кр╕Фр╕Зр╕Бр╕гр╕▓р╕Я (р╕Чр╕╡р╣Ир╣Ар╕Др╕вр╕лр╕▓р╕вр╣Др╕Ы р╣Ар╕нр╕▓р╕бр╕▓р╕Др╕╖р╕Щр╣Гр╕лр╣Йр╣Бр╕ер╣Йр╕з) ---
┬а ┬а ┬а ┬а ┬а ┬а st.divider()
┬а ┬а ┬а ┬а ┬а ┬а c1, c2 = st.columns(2)
┬а ┬а ┬а ┬а ┬а ┬а with c1:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╣Др╕Фр╣Йр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╣Бр╕нр╕Ы
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if not inc_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.plotly_chart(px.bar(inc_df.groupby('р╣Бр╕нр╕Ы')['р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤'].sum().reset_index(), x='р╣Бр╕нр╕Ы', y='р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤', color='р╣Бр╕нр╕Ы', text_auto=True, title="р╕гр╕▓р╕вр╣Др╕Фр╣Йр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╣Бр╕нр╕Ы"), use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а with c2:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а # р╕Бр╕гр╕▓р╕Яр╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓р╕Чр╕│р╣Ар╕Зр╕┤р╕Щ
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а if not inc_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а inc_df['Hour'] = pd.to_datetime(inc_df['р╣Ар╕зр╕ер╕▓'], format='%H:%M').dt.hour
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.plotly_chart(px.histogram(inc_df, x='Hour', y='р╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н/р╕кр╕╕р╕Чр╕Шр╕┤', nbins=24, title="ЁЯФе р╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓р╕Чр╕│р╣Ар╕Зр╕┤р╕Щ", color_discrete_sequence=['#FF4B4B']), use_container_width=True)
┬а ┬а ┬а ┬а ┬а ┬а┬а
┬а ┬а ┬а ┬а ┬а ┬а # р╕Бр╕гр╕▓р╕Яр╕зр╕Зр╕Бр╕ер╕бр╕гр╕▓р╕вр╕Ир╣Ир╕▓р╕в
┬а ┬а ┬а ┬а ┬а ┬а if not exp_df.empty:
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а st.plotly_chart(px.pie(exp_df, values='р╕лр╕▒р╕Б/р╕Ир╣Ир╕▓р╕в', names='р╕гр╕▓р╕вр╕Бр╕▓р╕г', title="ЁЯТ╕ р╕кр╕▒р╕Фр╕кр╣Ир╕зр╕Щр╕Др╣Ир╕▓р╣Гр╕Кр╣Йр╕Ир╣Ир╕▓р╕в", hole=0.4), use_container_width=True)

┬а ┬а ┬а ┬а else:
┬а ┬а ┬а ┬а ┬а ┬а st.warning(f"р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Кр╣Ир╕зр╕З: {time_filter}")
┬а ┬а else:
┬а ┬а ┬а ┬а st.info("р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕гр╕░р╕Ър╕Ъ")

# ==========================================
# TAB 3: р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е (р╣Ар╕Юр╕┤р╣Ир╕бр╕Хр╕▒р╕зр╕Бр╕гр╕нр╕Зр╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕лр╣Йр╕Хр╕▓р╕бр╕Чр╕╡р╣Ир╣Ар╕Др╕вр╕Вр╕н)
# ==========================================
with tab3:
┬а ┬а st.subheader("ЁЯЧВя╕П р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е")
┬а ┬а┬а
┬а ┬а # р╣Ар╕Юр╕┤р╣Ир╕бр╕Хр╕▒р╕зр╕Бр╕гр╕нр╕З (Filters) р╣Др╕зр╣Йр╕Фр╣Йр╕▓р╕Щр╕Ър╕Щ
┬а ┬а with st.container(border=True):
┬а ┬а ┬а ┬а st.write("ЁЯФН **р╕Хр╕▒р╕зр╕Бр╕гр╕нр╕Зр╕Др╣Йр╕Щр╕лр╕▓**")
┬а ┬а ┬а ┬а fc1, fc2 = st.columns(2)
┬а ┬а ┬а ┬а with fc1:┬а
┬а ┬а ┬а ┬а ┬а ┬а f_app = st.multiselect("р╣Ар╕ер╕╖р╕нр╕Бр╣Бр╕нр╕Ы:", options=st.session_state.data['р╣Бр╕нр╕Ы'].unique(), default=[])
┬а ┬а ┬а ┬а with fc2:
┬а ┬а ┬а ┬а ┬а ┬а ┬аf_month = st.checkbox("р╕Фр╕╣р╣Ар╕Йр╕Юр╕▓р╕░р╣Ар╕Фр╕╖р╕нр╕Щр╕Щр╕╡р╣Й", value=False)

┬а ┬а view_df = st.session_state.data.copy()
┬а ┬а if f_app: view_df = view_df[view_df['р╣Бр╕нр╕Ы'].isin(f_app)]
┬а ┬а if f_month:┬а
┬а ┬а ┬а ┬а today = get_thai_date()
┬а ┬а ┬а ┬а view_df = view_df[(pd.to_datetime(view_df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.month == today.month) & (pd.to_datetime(view_df['р╕зр╕▒р╕Щр╕Чр╕╡р╣И']).dt.year == today.year)]

┬а ┬а st.caption(f"р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е: {len(view_df)} р╕гр╕▓р╕вр╕Бр╕▓р╕г")
┬а ┬а if not view_df.empty:
┬а ┬а ┬а ┬а edited = st.data_editor(view_df.sort_values(by=["р╕зр╕▒р╕Щр╕Чр╕╡р╣И", "р╣Ар╕зр╕ер╕▓"], ascending=False), num_rows="dynamic", use_container_width=True)
┬а ┬а ┬а ┬а if st.button("ЁЯТ╛ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В", type="primary"):
┬а ┬а ┬а ┬а ┬а ┬а # Update р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕Чр╕╡р╣И Main DF (Logic р╕Зр╣Ир╕▓р╕вр╣Ж: р╕Чр╕▒р╕Ър╕Вр╕нр╕Зр╣Ар╕Бр╣Ир╕▓р╕Фр╣Йр╕зр╕в Index)
┬а ┬а ┬а ┬а ┬а ┬а st.session_state.data.update(edited)
┬а ┬а ┬а ┬а ┬а ┬а save_data(st.session_state.data)
┬а ┬а ┬а ┬а ┬а ┬а st.success("р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Бр╕ер╣Йр╕з")
┬а ┬а ┬а ┬а ┬а ┬а st.rerun()
┬а ┬а else:
┬а ┬а ┬а ┬а st.info("р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▓р╕бр╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕В")
┬а ┬а ┬а ┬а┬а
