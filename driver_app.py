import streamlit as st
import pandas as pd
import datetime
import plotly.express as px
import json
import os

# --- 1. CONFIGURATION ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö", page_icon="üöó", layout="wide")
DATA_FILE = "driver_data.csv"
SETTINGS_FILE = "settings.json"

# --- TIMEZONE ---
def get_thai_time():
    tz_thai = datetime.timezone(datetime.timedelta(hours=7))
    return datetime.datetime.now(tz_thai)

def get_thai_date():
    return get_thai_time().date()

# --- 2. SETTINGS MANAGEMENT ---
def load_settings():
    default_settings = {"maxim_rate": 15, "ev_rate": 40.0}
    if os.path.exists(SETTINGS_FILE):
        try:
            with open(SETTINGS_FILE, "r") as f: return json.load(f)
        except: return default_settings
    return default_settings

def save_settings(settings):
    with open(SETTINGS_FILE, "w") as f: json.dump(settings, f)

# --- 3. DATA LOADING ---
def load_and_clean_data():
    try:
        df = pd.read_csv(DATA_FILE)
        col_map = {
            'Date': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Time': '‡πÄ‡∏ß‡∏•‡∏≤', 'Platform': '‡πÅ‡∏≠‡∏õ',
            'Category': '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'SubCategory': '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
            'Amount_Gross': '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', 'Deduction': '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢',
            'Tip': '‡∏ó‡∏¥‡∏õ', 'Net_Income': '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
            'Distance_Km': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', 'Note': '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏',
            'Odometer': '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'
        }
        df.rename(columns=col_map, inplace=True)
        
        num_cols = ['‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå']
        for col in num_cols:
            if col not in df.columns: df[col] = 0.0
            else: df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
            
        if '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' in df.columns:
            df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] = pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.date
            
        return df
    except FileNotFoundError:
        return pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])

def save_data(df):
    df.to_csv(DATA_FILE, index=False)

if 'data' not in st.session_state:
    st.session_state.data = load_and_clean_data()
    save_data(st.session_state.data)

# --- 4. SIDEBAR ---
with st.sidebar:
    st.title("‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")
    st.caption(f"‡πÄ‡∏ß‡∏•‡∏≤: {get_thai_time().strftime('%H:%M')}")
    
    current_settings = load_settings()
    new_maxim_rate = st.slider("Maxim ‡∏´‡∏±‡∏Å‡∏Ñ‡∏≠‡∏° (%)", 0, 30, current_settings.get("maxim_rate", 15))
    new_ev_rate = st.number_input("‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", value=float(current_settings.get("ev_rate", 40.0)), step=5.0)
    
    if new_maxim_rate != current_settings.get("maxim_rate") or new_ev_rate != current_settings.get("ev_rate"):
        updated_settings = {"maxim_rate": new_maxim_rate, "ev_rate": new_ev_rate}
        save_settings(updated_settings)
        st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß!")
    
    maxim_comm_rate = new_maxim_rate / 100
    ev_home_rate = new_ev_rate
    
    st.divider()
    if st.button("‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", type="primary"):
        st.session_state.data = pd.DataFrame(columns=[
            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡πÅ‡∏≠‡∏õ', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 
            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢', '‡∏ó‡∏¥‡∏õ', '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', 
            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå', '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'
        ])
        save_data(st.session_state.data)
        st.rerun()

# --- 5. MAIN APP ---
st.title("üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
tab1, tab2, tab3 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô", "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "üóÇÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"])

# ==========================================
# TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô)
# ==========================================
with tab1:
    col_type, col_form = st.columns([1, 2])
    with col_type:
        st.subheader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        entry_type = st.radio(
            "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
            ["üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ", "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü", "üïí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô/‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå)", "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ", "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
        )

    with col_form:
        st.container(border=True)
        # --- 1. ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô ---
        if entry_type == "üöó ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ":
            st.markdown("#### üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
            with st.form(key="form_income", clear_on_submit=True):
                # ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏≠‡∏õ ‡πÅ‡∏•‡∏∞ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
                c_app, c_pay = st.columns(2)
                with c_app:
                    platform = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ", ["Grab", "Bolt", "Line Man", "Maxim", "Robinhood", "Win", "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å"])
                with c_pay:
                    # ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
                    payment_channel = st.radio("‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏´‡∏ô?", ["üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "üí≥ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ/‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ï‡∏£"], horizontal=True)

                # ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏Ñ‡∏≤
                c1, c2 = st.columns(2)
                with c1: 
                    app_price = st.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ", min_value=0.0, step=10.0, value=None, placeholder="0.00")
                with c2: 
                    real_receive = st.number_input("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏õ)", min_value=0.0, step=10.0, value=None, placeholder="‡πÄ‡∏ó‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ")
                
                note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‚úÖ", type="primary", use_container_width=True)
                
                if submitted:
                    price_val = app_price if app_price is not None else 0.0
                    real_val = real_receive if real_receive is not None else 0.0
                    
                    if price_val > 0 or real_val > 0:
                        if real_val == 0: real_val = price_val 
                        
                        deduction = 0
                        tip = max(0, real_val - price_val)
                        
                        if platform == "Maxim":
                            deduction = price_val * maxim_comm_rate
                            net_income = price_val - deduction + tip
                        else:
                            net_income = price_val + tip 
                        
                        # ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ)
                        item_name = "‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£ (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)" if "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" in payment_channel else "‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£ (‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ)"

                        new_row = {
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                            '‡πÅ‡∏≠‡∏õ': platform, '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 
                            '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item_name, # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢
                            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': price_val, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': deduction, '‡∏ó‡∏¥‡∏õ': tip, 
                            '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': net_income, '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, 
                            '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"[{payment_channel}] {note}" # ‡πÅ‡∏õ‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                        }
                        st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                        save_data(st.session_state.data)
                        
                        # ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        msg_cash = f"‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î {real_val:.0f} ‡∏ö‡∏≤‡∏ó" if "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î" in payment_channel else f"‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ {net_income:.0f} ‡∏ö‡∏≤‡∏ó"
                        st.toast(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! {msg_cash}")
                        st.rerun()
                    else:
                        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô")

        # --- 2. ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü ---
        elif entry_type == "‚õΩ ‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü":
            st.markdown("#### ‚ö° ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô")
            with st.form(key="form_energy", clear_on_submit=True):
                e_type = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‚õΩ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)", "üîå ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ"], horizontal=True)
                default_val = None
                if e_type == "‚ö° ‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏≤)": default_val = float(ev_home_rate)
                
                cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, value=default_val, placeholder="0.00")
                note = st.text_input("‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ üíæ", type="primary", use_container_width=True)
                if submitted:
                    cost_val = cost if cost is not None else 0.0
                    if cost_val > 0:
                        new_row = {
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                            '‡πÅ‡∏≠‡∏õ': '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü',
                            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost_val, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost_val,
                            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"{e_type} - {note}"
                        }
                        st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                        save_data(st.session_state.data)
                        st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
                        st.rerun()
                    else:
                        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô")

        # --- 3. ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå ---
        elif entry_type == "üïí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô/‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå)":
            st.markdown("#### üïí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå")
            with st.form(key="form_odom", clear_on_submit=True):
                shift_type = st.radio("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["‚òÄÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "üåô ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô"], horizontal=True)
                last_odom = 0.0
                if not st.session_state.data.empty: last_odom = st.session_state.data['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'].max()
                st.caption(f"‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: {last_odom:,.0f}")
                odometer = st.number_input("‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", min_value=0.0, step=1.0, value=None, placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå üíæ", type="primary", use_container_width=True)
                if submitted:
                    odom_val = odometer if odometer is not None else 0.0
                    if odom_val > 0:
                        new_row = {
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                            '‡πÅ‡∏≠‡∏õ': '‡∏£‡∏∞‡∏ö‡∏ö', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏Å‡∏∞‡∏á‡∏≤‡∏ô', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': shift_type,
                            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': 0, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': 0,
                            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': odom_val, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': f"‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå {shift_type}"
                        }
                        st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                        save_data(st.session_state.data)
                        st.toast(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å {shift_type} ‡πÅ‡∏•‡πâ‡∏ß")
                        st.rerun()
                    else:
                        st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå")

        # --- 4. ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï/‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
        elif entry_type == "üí≥ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÅ‡∏≠‡∏õ" or entry_type == "üõ†Ô∏è ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
            st.markdown(f"#### {entry_type}")
            with st.form(key="form_other", clear_on_submit=True):
                if "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" in entry_type:
                    item_name = "‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï"
                    sub_cat = st.selectbox("‡πÅ‡∏≠‡∏õ‡πÑ‡∏´‡∏ô", ["Grab Wallet", "Bolt", "Maxim", "Line Man"])
                else:
                    item_name = "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
                    sub_cat = st.text_input("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏õ‡∏∞‡∏¢‡∏≤‡∏á)")
                
                cost = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0, value=None, placeholder="0.00")
                submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ", type="primary", use_container_width=True)
                
                if submitted:
                    cost_val = cost if cost is not None else 0.0
                    if cost_val > 0:
                        new_row = {
                            '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà': get_thai_date(), '‡πÄ‡∏ß‡∏•‡∏≤': get_thai_time().strftime("%H:%M"),
                            '‡πÅ‡∏≠‡∏õ': sub_cat if "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï" in entry_type else '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢',
                            '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item_name,
                            '‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°/‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ': 0, '‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢': cost_val, '‡∏ó‡∏¥‡∏õ': 0, '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥': -cost_val,
                            '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)': 0, '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå': 0, '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏': sub_cat
                        }
                        st.session_state.data = pd.concat([st.session_state.data, pd.DataFrame([new_row])], ignore_index=True)
                        save_data(st.session_state.data)
                        st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
                        st.rerun()
                    else:
                        st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô")
                        
# ==========================================
# TAB 2: DASHBOARD PRO (Brand Colors Edition)
# ==========================================
with tab2:
    st.markdown("### üöÄ Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
    
    # --- Color Mapping (‡∏ä‡∏∏‡∏î‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏≠‡∏õ) ---
    APP_COLORS = {
        "Grab": "#00B14F",      # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß Grab
        "Line Man": "#06C755",  # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß Line Man
        "Bolt": "#34D186",      # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß Bolt (Mint)
        "Maxim": "#FFD600",     # ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á Maxim
        "Robinhood": "#9D2398", # ‡∏°‡πà‡∏ß‡∏á Robinhood
        "Win": "#FF6B00",       # ‡∏™‡πâ‡∏° ‡∏ß‡∏¥‡∏ô
        "‡∏á‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å": "#7F8C8D",    # ‡πÄ‡∏ó‡∏≤
        "‡∏£‡∏∞‡∏ö‡∏ö": "#95A5A6"       # ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô
    }

    # --- Filter Section ---
    with st.container(border=True):
        c_filter, c_date = st.columns([1, 2])
        with c_filter:
            time_filter = st.selectbox(
                "üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:",
                ["‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß", "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ", "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á"]
            )
        with c_date:
            custom_start, custom_end = None, None
            if time_filter == "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á":
                dr = st.date_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", value=(get_thai_date(), get_thai_date()))
                if len(dr) == 2: custom_start, custom_end = dr
            else:
                st.info(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {time_filter}")

    # --- Data Preparation ---
    df = st.session_state.data
    if not df.empty:
        # Filter Logic
        today = get_thai_date()
        filter_df = df.copy()
        
        if time_filter == "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ":
            start_week = today - datetime.timedelta(days=today.weekday())
            filter_df = df[df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] >= start_week]
        elif time_filter == "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ":
            filter_df = df[(pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.month == today.month) & (pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.year == today.year)]
        elif time_filter == "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß":
            first = today.replace(day=1); last_prev = first - datetime.timedelta(days=1); start_prev = last_prev.replace(day=1)
            filter_df = df[(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] >= start_prev) & (df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] <= last_prev)]
        elif time_filter == "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ":
            filter_df = df[pd.to_datetime(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']).dt.year == today.year]
        elif time_filter == "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á" and custom_start:
            filter_df = df[(df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] >= custom_start) & (df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] <= custom_end)]
        
        if filter_df.empty:
            st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ")
        else:
            # --- CALCULATIONS ---
            income_df = filter_df[filter_df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö']
            expense_df = filter_df[filter_df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢']
            
            total_rev = income_df['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum()
            total_exp = expense_df['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
            net_profit = total_rev - total_exp
            
            # Distance & Fuel
            odom_rows = filter_df[filter_df['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'] > 0]
            total_km = 0
            if not odom_rows.empty:
                daily_odom = odom_rows.groupby('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå'].agg(['min', 'max'])
                total_km = (daily_odom['max'] - daily_odom['min']).sum()
            if total_km == 0: total_km = filter_df['‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á(‡∏Å‡∏°.)'].sum()

            fuel_cost = expense_df[expense_df['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô/‡πÑ‡∏ü']['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum()
            cost_per_km = fuel_cost / total_km if total_km > 0 else 0

            # Time
            shift_df = filter_df[filter_df['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'] == '‡∏Å‡∏∞‡∏á‡∏≤‡∏ô']
            total_hours = 0
            if not shift_df.empty:
                for d in shift_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].unique():
                    day_shifts = shift_df[shift_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] == d]
                    starts = day_shifts[day_shifts['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'].str.contains("‡πÄ‡∏£‡∏¥‡πà‡∏°")]['‡πÄ‡∏ß‡∏•‡∏≤']
                    ends = day_shifts[day_shifts['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'].str.contains("‡πÄ‡∏•‡∏¥‡∏Å")]['‡πÄ‡∏ß‡∏•‡∏≤']
                    if not starts.empty and not ends.empty:
                        try:
                            t_s = pd.to_datetime(starts.min(), format='%H:%M')
                            t_e = pd.to_datetime(ends.max(), format='%H:%M')
                            h = (t_e - t_s).total_seconds() / 3600
                            if h < 0: h += 24
                            total_hours += h
                        except: pass
            
            hourly_rate = total_rev / total_hours if total_hours > 0 else 0

            # --- TOP METRICS ---
            st.markdown("#### üèÜ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£")
            kpi1, kpi2, kpi3, kpi4 = st.columns(4)
            with kpi1: st.metric("üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", f"{net_profit:,.0f} ‡∏ö.", delta=f"‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö {total_rev:,.0f}")
            with kpi2: st.metric("üí∏ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", f"{total_exp:,.0f} ‡∏ö.", delta=f"-{fuel_cost:,.0f} ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á", delta_color="inverse")
            with kpi3: st.metric("üõ£Ô∏è ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏Å‡∏°.", f"{cost_per_km:.2f} ‡∏ö.")
            with kpi4: st.metric("‚è±Ô∏è ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏ä‡∏°.", f"{hourly_rate:.0f} ‡∏ö.")

            st.divider()

            # --- ROW 1: APP BREAKDOWN (‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå) ---
            st.subheader("üé® ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏≠‡∏õ (Brand Colors)")
            c1, c2 = st.columns([1, 1])
            
            if not income_df.empty:
                app_sum = income_df.groupby('‡πÅ‡∏≠‡∏õ')['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum().reset_index()
                
                with c1:
                    # 1. Bar Chart ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
                    fig_bar = px.bar(
                        app_sum, x='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', y='‡πÅ‡∏≠‡∏õ', orientation='h',
                        text_auto=True, color='‡πÅ‡∏≠‡∏õ', 
                        color_discrete_map=APP_COLORS, # ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏≠‡∏õ
                        title="‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î"
                    )
                    st.plotly_chart(fig_bar, use_container_width=True)
                
                with c2:
                    # 2. Donut Chart
                    fig_pie = px.pie(
                        app_sum, values='‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', names='‡πÅ‡∏≠‡∏õ', 
                        hole=0.4, color='‡πÅ‡∏≠‡∏õ',
                        color_discrete_map=APP_COLORS, # ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÅ‡∏≠‡∏õ
                        title="‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (%)"
                    )
                    st.plotly_chart(fig_pie, use_container_width=True)
            else:
                st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö")

            # --- ROW 2: DAILY TREND (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic: ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥) ---
            st.divider()
            st.subheader("üìà ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)")
            if not income_df.empty:
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏° (Income)
                daily_inc = income_df.groupby('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')['‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'].sum().reset_index()
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Expense)
                daily_exp = expense_df.groupby('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà')['‡∏´‡∏±‡∏Å/‡∏à‡πà‡∏≤‡∏¢'].sum().reset_index()
                
                # ‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
                daily_chart = pd.merge(daily_inc, daily_exp, on='‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', how='outer').fillna(0)
                daily_chart.columns = ['Date', 'Income', 'Expense']
                
                # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (Grouped Bar)
                fig_trend = px.bar(
                    dail
